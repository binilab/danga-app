# DANGA (danga.site) — Vibe Coding A~Z 진행 문서

## Part 10: 관리자(Admin) + 신고(Reports) MVP + 권한(Role) 기반 접근 제어

> Part 10은 “운영이 가능한 서비스”로 만들어주는 파트입니다.  
> 커뮤니티는 반드시 신고/관리/제재가 필요합니다.  
> 이번 파트 목표는 **최소 운영 도구**(신고 리스트/처리/삭제/권한)까지 구현하는 것입니다.

---

## 0. 전제(Part 9까지 완료)

- ✅ Auth + profiles(role 포함)
- ✅ posts/votes/comments + soft delete
- ✅ rankings
- ✅ /me(프로필 편집/탈퇴 soft delete)
- ✅ 배포 환경(danga.site)에서 기본 기능 동작

---

## 1. Part 10 목표(MVP)

1. `reports` 테이블 생성 (게시글/댓글 신고)
2. `/admin` 페이지 구현
3. Admin 권한 체크:
   - profiles.role == 'admin'만 접근 가능
4. 관리 기능(최소):
   - 신고 리스트 조회
   - 신고 상태 변경(open → reviewing → resolved/rejected)
   - 신고 대상(post/comment) soft delete 처리
   - 유저 role 변경(user ↔ admin) (선택)
5. 운영 로그(선택/간단):
   - admin_actions 테이블로 “누가 무엇을 했는지” 기록(Part 10.5)

---

## 2. 권한 정책(핵심)

### 2.1 Admin 판별 기준

- `profiles.role = 'admin'`

### 2.2 /admin 접근 제어

- 서버/페이지 로딩 시:
  - 세션 체크
  - profiles 조회
  - admin 아니면 “권한 없음” 화면 + 랜딩 이동 버튼

> 주의: 프론트 UI만 막으면 안 됨.  
> DB도 정책이 있어야 안전합니다. (MVP에서는 “관리 행위”를 RPC로 감싸는 방식 추천)

---

## 3. DB 설계: reports(신고)

### 3.1 reports 테이블 필드

- `id` uuid pk
- `target_type` text ('post' | 'comment')
- `target_id` uuid (posts.id or comments.id)
- `reporter_id` uuid (auth.users.id)
- `reason` text
- `status` text ('open' | 'reviewing' | 'resolved' | 'rejected')
- `created_at` timestamptz
- `reviewed_by` uuid (auth.users.id) nullable
- `reviewed_at` timestamptz nullable
- `notes` text nullable (관리자 메모)

### 3.2 중복 신고 방지(선택)

- 같은 유저가 같은 타겟을 중복 신고하지 못하게 unique
  - UNIQUE(target_type, target_id, reporter_id)

---

## 4. RLS 전략(중요)

MVP에서 가장 안전하고 단순한 방법:

- reports:
  - **insert**: 로그인 유저 누구나 가능(본인 reporter_id)
  - **select**:
    - 일반 유저는 “내가 신고한 것만”
    - admin은 “전체”
  - **update**: admin만
- posts/comments 삭제(soft delete)는:
  - 일반 유저는 본인 것만 가능(이미 Part 5/7에서 구현)
  - admin이 남의 글/댓글을 지우려면:
    - (A) admin 전용 RPC(Function) 사용 권장
    - (B) 또는 RLS에서 role 조건까지 넣는 방식(조금 복잡)

> 추천: MVP는 (A) RPC 2개로 “admin delete post/comment” 처리

---

## 5. Supabase SQL (Part 10) — 복붙 실행용

### 5.1 reports 테이블 + RLS

```sql
create table if not exists public.reports (
  id uuid primary key default gen_random_uuid(),
  target_type text not null check (target_type in ('post','comment')),
  target_id uuid not null,
  reporter_id uuid not null references auth.users(id) on delete cascade,
  reason text not null,
  status text not null default 'open' check (status in ('open','reviewing','resolved','rejected')),
  created_at timestamptz default now(),
  reviewed_by uuid references auth.users(id),
  reviewed_at timestamptz,
  notes text
);

create unique index if not exists reports_unique_once
on public.reports (target_type, target_id, reporter_id);

alter table public.reports enable row level security;

-- 누구나: 본인이 신고한 것만 조회
create policy "reports_select_own"
on public.reports for select
using (auth.uid() = reporter_id);

-- 누구나: 본인 reporter_id로만 신고 생성
create policy "reports_insert_own"
on public.reports for insert
with check (auth.uid() = reporter_id);


-- admin인지 확인하는 헬퍼 뷰(간단)
create or replace view public.admin_users as
select id
from public.profiles
where role = 'admin' and deleted_at is null;

-- admin 전체 조회
create policy "reports_select_admin_all"
on public.reports for select
using (exists (select 1 from public.admin_users au where au.id = auth.uid()));

-- admin 업데이트 가능
create policy "reports_update_admin"
on public.reports for update
using (exists (select 1 from public.admin_users au where au.id = auth.uid()))
with check (exists (select 1 from public.admin_users au where au.id = auth.uid()));

create or replace function public.admin_soft_delete_post(p_post_id uuid)
returns void
language plpgsql
security definer
as $$
begin
  if not exists (select 1 from public.profiles where id = auth.uid() and role = 'admin' and deleted_at is null) then
    raise exception 'not admin';
  end if;

  update public.posts
  set deleted_at = now()
  where id = p_post_id;
end;
$$;

create or replace function public.admin_soft_delete_comment(p_comment_id uuid)
returns void
language plpgsql
security definer
as $$
begin
  if not exists (select 1 from public.profiles where id = auth.uid() and role = 'admin' and deleted_at is null) then
    raise exception 'not admin';
  end if;

  update public.comments
  set deleted_at = now()
  where id = p_comment_id;
end;
$$;
```
