# DANGA (danga.site) — 커뮤니티 필수 기능 스프린트

## Part 17: 대댓글(스레드) + 멘션 + 댓글 정렬 + 알림 연동(선택)

> 목표: “커뮤니티답게 대화가 이어지는 구조”를 만든다.  
> 댓글만 있으면 대화가 끊기고, 대댓글이 있어야 ‘싸움/토론/피드백 흐름’이 생김.

---

## 0. 전제

- ✅ posts / votes(좋아요) / comments(댓글) / profiles / auth 완료
- ✅ /p/[id] 상세에서 댓글 작성/삭제(soft delete) 동작
- ✅ (선택) notifications가 있으면 멘션/대댓글 알림 연동 가능

---

## 1. 이번 스프린트에서 “필수”로 할 것

### 1.1 대댓글(스레드) MVP

- 댓글(comment)에 “부모 댓글(parent)”을 연결해서 스레드 구성
- UI에서 “답글 달기” → 해당 댓글 아래에 대댓글 리스트 표시

### 1.2 멘션(@닉네임) MVP (선택이지만 추천)

- 답글 달 때 자동으로 `@nickname` 프리필(UX)
- 멘션을 파싱해서 알림(Part 14가 있으면)

### 1.3 댓글 정렬(필수)

- “오래된순/최신순” 토글
- 대댓글은 기본 “오래된순” 권장(대화 흐름)

### 1.4 스팸 방지 최소

- 연타 방지(버튼 disable)
- 길이 제한(이미 했으면 유지)
- (선택) 10초에 3개 이상 작성 제한(서버에서 간단 체크)

---

## 2. DB 설계(대댓글)

현재 `comments` 테이블에 컬럼 추가로 간다.

### 2.1 추가 컬럼

- `parent_id uuid NULL references comments(id)`
- `depth int default 0` (MVP에서는 0/1만 쓰면 됨)
- `reply_to_user_id uuid NULL` (선택, 답글 대상 유저)

> MVP에서는 depth를 강제하지 않아도 되지만,
> “대댓글까지만(2단)”을 강제하려면 depth가 편함.

---

## 3. Supabase SQL (Part 17) — 복붙 실행용

> Supabase SQL Editor에서 Run

### 3.1 컬럼 추가

```sql
alter table public.comments
add column if not exists parent_id uuid references public.comments(id) on delete cascade;

alter table public.comments
add column if not exists depth int not null default 0;

alter table public.comments
add column if not exists reply_to_user_id uuid references auth.users(id) on delete set null;
create index if not exists comments_post_parent_created_idx
on public.comments (post_id, parent_id, created_at asc);

alter table public.comments
add constraint comments_depth_check
check (depth in (0,1));
```
