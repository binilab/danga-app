# DANGA 진행사항

## 2026-02-15 Part 1 뼈대 작업 기록

### 1) 라우트/페이지 뼈대 생성
- `app/page.tsx` 랜딩 페이지 구성
- `app/feed/page.tsx` 피드 페이지 생성
- `app/rank/page.tsx` 랭킹 페이지 생성
- `app/me/page.tsx` 마이페이지 placeholder 생성
- `app/post/new/page.tsx` 업로드 화면 placeholder 생성
- `app/p/[id]/page.tsx` 상세 동적 라우트 생성
- `app/admin/page.tsx` 관리자 placeholder 생성

### 2) 공통 레이아웃 정리
- `app/layout.tsx`
  - 전역 메타데이터를 DANGA 컨셉에 맞게 수정
  - 공통 헤더를 전체 페이지에 적용
  - 본문 최대 폭/여백 공통화

### 3) 공통 컴포넌트 분리
- `components/Header.tsx`
  - 좌측 로고, 가운데 메뉴(Feed/Rank), 우측 CTA(시작하기)
  - 모바일에서도 줄바꿈이 자연스럽도록 `flex-wrap` 반영
  - 현재 경로 기준 활성 메뉴 스타일 반영
- `components/PostCard.tsx`
  - 피드/랜딩/상세에서 재사용 가능한 게시글 카드 컴포넌트
- `components/PageTitle.tsx`
  - 페이지 타이틀/설명 영역 공통화

### 4) 더미 데이터 분리
- `lib/mock.ts`
  - 게시글 12개 더미 데이터 작성
  - 랭킹 데이터 제공
  - 상세 페이지 조회용 `getPostById` 함수 작성

### 5) 스타일/디자인 톤 정리
- `app/globals.css`
  - 빠르고 경쾌한 느낌의 색상 변수 정의
  - 공통 카드 스타일(`.danga-panel`) 정의

### 6) 문서 업데이트
- `README.md`
  - 프로젝트 소개, 구현 범위, 실행 방법, 폴더 구조 업데이트
- `docs/진행사항.md`
  - 본 문서 생성 및 작업 상세 로그 기록 시작

## 2026-02-15 랜딩 페이지 고도화(UI 전용) 작업 기록

### 1) 랜딩 섹션 분리 및 조립 구조 변경
- `app/page.tsx`
  - 랜딩 페이지를 섹션 조립 전용 파일로 변경
  - 섹션 순서: Hero -> HowItWorks -> SampleGallery -> RankPreview -> CTA

### 2) 랜딩 전용 컴포넌트 추가
- `components/landing/Hero.tsx`
  - 메인 카피 `단번에 가자`
  - 서브 카피 `코디 올리고, 투표로 바로 평가받자.`
  - CTA 버튼 2개
    - `지금 올리기` -> `/post/new`
    - `구경하기` -> `/feed`
  - 더미 지표(코디 수, 투표 수, 댓글 수) 표시
- `components/landing/HowItWorks.tsx`
  - 3단계 카드(올린다/투표받는다/랭킹 오른다)
- `components/landing/SampleGallery.tsx`
  - 더미 카드 10개 렌더링
  - 각 카드에 이미지 placeholder, 투표수, 댓글수, 작성자 닉네임 표시
  - 이미지는 `next/image` 사용
- `components/landing/RankPreview.tsx`
  - 이번 주 Top 10 미리보기
  - `상위 1%` 배지 예시 카드 포함
- `components/landing/CTA.tsx`
  - 하단 대형 카피 + 단일 CTA 버튼 구성

### 3) 더미 데이터 확장
- `lib/mock.ts`
  - `landingHowSteps` 추가
  - `landingGalleryItems` 추가(10개)
  - `weeklyTopRankers` 추가(Top 10)
  - `createPlaceholderImage` 추가
    - 로컬 이미지 없이도 쓸 수 있는 SVG data URL 생성 함수

### 4) 헤더/UI 톤 개선
- `components/Header.tsx`
  - 기존 구조 유지하면서 스타일을 더 정돈된 느낌으로 미세 조정
  - hover 반응/활성 상태를 명확하게 보이도록 개선
- `app/globals.css`
  - 과한 그라데이션 대신 은은한 배경 톤으로 정리

### 5) 품질 검증
- `npm run lint` 통과
- `npm run build` 통과

### 6) 미구현/다음 단계 메모
- 인증/권한(Supabase Auth) 미연동
- 실제 업로드/투표/댓글/신고 기능 미연동
- 무한스크롤 미구현(현재 `더 보기` 버튼)
- 관리자 기능은 placeholder 상태

## 2026-02-15 Part 3 Auth + Header 상태 반영 작업 기록

### 1) Supabase 클라이언트 설정
- `lib/supabase/client.ts`
  - 브라우저용 Supabase 클라이언트 싱글턴 생성
  - `.env.local` 환경 변수 유효성 검사 추가
- `lib/supabase/server.ts`
  - 서버용 Supabase 클라이언트 생성
  - App Router 쿠키 저장/갱신 처리 포함

### 2) OAuth callback 라우트 추가
- `app/auth/callback/route.ts`
  - OAuth 인증 후 `code`를 세션으로 교환
  - 로그인 취소/실패 시 `authMessage`를 URL로 전달해 사용자 안내
  - 외부 URL 리다이렉트 방지를 위해 내부 경로만 허용

### 3) 로그인 모달 구현
- `components/auth/LoginModal.tsx`
  - Header `시작하기` 버튼 클릭 시 모달 오픈
  - Google / Kakao 로그인 버튼 제공
  - 로그인 실패 시 모달 내 안내 문구 표시
  - Kakao 미설정 시 확인 문구 표시

### 4) 로그인 상태 헤더 반영
- `components/Header.tsx`
  - 세션 확인 후 상태별 UI 분기
    - 비로그인: `시작하기` 버튼
    - 로그인: 원형 프로필 버튼 + 드롭다운
  - `profiles` 조회 + (로그인 시) upsert 처리로 닉네임/아바타 동기화
  - 인증 에러 메시지 토스트 안내 반영
- `components/auth/ProfileMenu.tsx`
  - 드롭다운 메뉴 구성
    - 내 피드(`/me`)
    - 업로드(`/post/new`)
    - 로그아웃

### 5) 로그아웃 구현
- Header 드롭다운의 `로그아웃` 클릭 시
  - Supabase 세션 종료
  - 랜딩(`/`)으로 이동

### 6) profiles 테이블 가이드 추가
- `docs/sql/profiles.sql`
  - `profiles` 테이블 생성
  - RLS 정책(본인 조회/생성/수정)
  - `updated_at` 자동 갱신 트리거

### 7) 품질 검증 메모
- lint/build 검증 예정
- local dev에서 OAuth 동작은 Supabase Provider 설정 상태에 따라 달라짐

## 2026-02-15 Part 4 Cloudflare R2 업로드 파이프라인 작업 기록

### 1) 서버 전용 R2 유틸 구현
- `lib/r2.ts`
  - `@aws-sdk/client-s3` 기반 R2 S3Client 설정
  - endpoint: `https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com`
  - `region: auto` 적용
  - env에서 자격 증명 로드
  - `PutObjectCommand`로 업로드
  - key 생성 규칙 구현
    - `posts/{userId}/{Date.now()}-{random}.{ext}`
  - 파일명 확장자 sanitize + content-type 기반 확장자 보정
  - userId sanitize 처리

### 2) 업로드 API 라우트 구현
- `app/api/upload/route.ts`
  - `POST multipart/form-data` 처리 (`file` 필드)
  - 허용 타입 제한: `image/png`, `image/jpeg`, `image/webp`
  - 최대 용량 5MB 제한 (초과 시 413)
  - 세션 사용자 조회 후 key userId 반영
    - 로그인 사용자는 `supabase auth user.id`
    - 미로그인은 `anon`
  - 성공 응답
    - `{ ok: true, key, url }`
  - 예외 처리 + status code 분기
    - 400: 파일 누락/형식 오류
    - 415: 지원하지 않는 MIME
    - 413: 용량 초과
    - 500: 서버 내부 오류

### 3) /post/new 업로더 UI 구현
- `components/post/ImageUploader.tsx` 추가
  - 파일 선택
  - 업로드 버튼
  - 업로드 중 로딩 상태 + 버튼 비활성화
  - 성공 시 미리보기 이미지 표시
  - 업로드 URL 텍스트 + 복사 버튼
  - 실패 시 사용자 친화적 에러 표시
- `app/post/new/page.tsx`
  - 기존 입력 폼 위에 `ImageUploader` 조립

### 4) 보안/구조 메모
- R2 접근은 API 라우트(`app/api/upload/route.ts`)에서만 수행
- 클라이언트에는 R2 키/시크릿이 전달되지 않음
- 서버/클라이언트 컴포넌트 분리
  - 페이지(`app/post/new/page.tsx`)는 서버 컴포넌트 유지
  - 업로더(`components/post/ImageUploader.tsx`)는 클라이언트 컴포넌트

### 5) 품질 검증 메모
- lint/build 검증 예정
- 실제 업로드 확인은 `.env.local`의 R2 값이 올바를 때 가능

## 2026-02-16 Part 5 posts 테이블 + 작성/피드/상세 구현 기록

### 1) Supabase migration 추가 (posts)
- `supabase/migrations/20260216_create_posts.sql`
  - `public.posts` 테이블 생성
    - `id`, `user_id`, `image_url`, `image_key`, `caption`, `created_at`, `updated_at`, `deleted_at`
  - soft delete 기본 구조(`deleted_at`) 반영
  - 인덱스 추가
    - 최신순 조회용 partial index (`deleted_at is null`)
    - user_id + created_at index
    - deleted_at index
  - RLS/policies 추가
    - select: 공개 조회 가능(soft delete 제외)
    - insert/update: 본인 글만 허용
  - `updated_at` 자동 갱신 트리거 추가
- 실행 편의용 SQL 복사본
  - `docs/sql/posts.sql`

### 2) 게시글 생성 API 추가
- `app/api/posts/route.ts`
  - `POST` 요청으로 게시글 생성
  - 요청 본문: `imageUrl`, `imageKey`, `caption`
  - 세션 사용자 확인 후 `user_id`를 서버에서 강제 적용
  - 유효성 검증
    - 이미지 URL 필수
    - 캡션 필수 / 500자 제한
  - 저장 성공 시 `{ ok: true, id }` 반환

### 3) /post/new 작성 흐름 완성
- `components/post/ImageUploader.tsx`
  - 업로드 성공 후 캡션 입력 UI 제공
  - `게시글 등록` 버튼으로 `POST /api/posts` 호출
  - 저장 성공 시 `/feed` 이동
- `app/post/new/page.tsx`
  - 기존 더미 폼 제거, 실제 작성 흐름 중심으로 정리

### 4) /feed 조회 구현
- `app/feed/page.tsx`
  - `posts` 테이블 최신순 조회
  - `deleted_at is null` 조건 적용
  - 20개 로딩 + `더보기` 버튼(page query)
  - 이미지는 `image_key` 기준 서명 URL 우선 표시(실패 시 `image_url` fallback)
- `components/post/PostItemCard.tsx`
  - 피드/상세 공용 카드 컴포넌트 추가

### 5) /p/[id] 상세 구현
- `app/p/[id]/page.tsx`
  - posts 단건 조회
  - `deleted_at is null` 조건 적용
  - 조회 실패 시 `notFound()` 처리

### 6) 공용 타입/유틸 추가
- `lib/posts.ts`
  - `PostRow` 타입
  - 작성자 라벨/날짜 포맷 유틸

### 7) 품질 검증 메모
- lint/build 검증 예정
- 운영 확인 목표
  - 로그인 -> 이미지 업로드 -> 게시글 생성 -> feed 노출

## 2026-02-16 Part 6 투표(좋아요) MVP 구현 기록

### 1) votes 토글 API 추가
- `app/api/votes/route.ts`
  - `POST`: 좋아요 생성
  - `DELETE`: 좋아요 취소
  - 로그인 사용자 검사
  - `postId` 유효성(UUID 형식) 검사
  - 응답에 `likedByMe`, `count` 반환
  - 중복 좋아요(`unique(post_id, voter_id)`) 충돌은 정상 처리

### 2) 좋아요 로직 재사용 훅 분리
- `hooks/useVote.ts`
  - optimistic UI 토글
  - 실패 시 원복 + 안내 메시지
  - 중복 연타 방지(`isPending`)
  - 비로그인 시 로그인 모달 오픈 이벤트(`danga:open-login`) 전송

### 3) votes 집계 유틸 추가
- `lib/votes.ts`
  - `postIds` 기준 votes를 `in()`으로 한 번에 조회
  - `count` + `likedByMe` 집계 맵 생성
  - N+1 조회 방지

### 4) UI 반영
- `components/post/VoteButton.tsx`
  - 하트 버튼 + 좋아요 수 표시
  - 활성/비활성 스타일 분리
  - 오류 메시지 표시
- `components/post/PostItemCard.tsx`
  - 카드 하단에 좋아요 버튼 배치
  - 링크 클릭 영역과 버튼 영역 분리(상호작용 충돌 방지)

### 5) /feed 반영
- `app/feed/page.tsx`
  - posts 20개 조회 후 post ids 추출
  - votes를 한 번에 조회해 카드별 좋아요 정보 주입
  - 로그인 여부에 따라 버튼 동작 분기

### 6) /p/[id] 반영
- `app/p/[id]/page.tsx`
  - 상세 단건에도 좋아요 집계/토글 동일 적용

### 7) 헤더 로그인 모달 연동
- `components/Header.tsx`
  - `danga:open-login` 이벤트 수신 시 로그인 모달 오픈
  - 비로그인 사용자의 좋아요 클릭에서 모달 유도 가능

### 8) 품질 검증
- `npm run lint` 통과
- `npm run build` 통과

### 9) 운영 확인 체크포인트
- 로그인 상태에서 feed/상세 좋아요 토글 가능
- 새로고침 후 좋아요 상태/카운트 일치
- 비로그인 좋아요 클릭 시 로그인 모달 유도

## 2026-02-16 Part 6 votes 테이블 SQL 추가 기록

### 1) Supabase migration 추가 (votes)
- `supabase/migrations/20260216_create_votes.sql`
  - `public.votes` 테이블 생성
    - `post_id`, `voter_id`, `created_at`
  - 기본키 `(post_id, voter_id)`로 중복 좋아요 방지
  - 인덱스 추가
    - `voter_id`
    - `created_at desc`
  - RLS/policies 추가
    - select all
    - insert own
    - delete own

### 2) 실행 편의용 SQL 문서 추가
- `docs/sql/votes.sql`
  - migration과 동일한 내용 제공

### 3) 문서 반영
- `README.md`
  - 사전 설정 단계에 `docs/sql/votes.sql` 실행 절차 추가
  - 폴더 구조에 `docs/sql/votes.sql`, `supabase/migrations/20260216_create_votes.sql` 반영

## 2026-02-16 Part 6 votes 테이블 SQL 추가 기록

### 1) Supabase migration 추가 (votes)
- `supabase/migrations/20260216_create_votes.sql`
  - `public.votes` 테이블 생성
    - `post_id`, `voter_id`, `created_at`
  - 기본키 `(post_id, voter_id)`로 중복 좋아요 방지
  - 인덱스 추가
    - `voter_id`
    - `created_at desc`
  - RLS/policies 추가
    - select all
    - insert own
    - delete own

### 2) 실행 편의용 SQL 문서 추가
- `docs/sql/votes.sql`
  - migration과 동일한 내용 제공

### 3) 문서 반영
- `README.md`
  - 사전 설정 단계에 `docs/sql/votes.sql` 실행 절차 추가
  - 폴더 구조에 `docs/sql/votes.sql`, `supabase/migrations/20260216_create_votes.sql` 반영

## 2026-02-16 Part 8 주간/월간 랭킹 + 퍼센타일 뱃지 구현 기록

### 1) 1.md 기준 확인 후 구현
- `docs/1.md` Part 8 목표/집계 전략을 기준으로 반영
- 랭킹 조회 소스
  - `weekly_post_rankings`
  - `monthly_post_rankings`

### 2) /rank 페이지 실데이터 구현
- `app/rank/page.tsx`
  - 주간/월간 탭 UI (`?period=weekly|monthly`)
  - 선택 탭의 뷰에서 Top 50 조회(rank asc)
  - N+1 방지 조회 전략 적용
    - ranking view 조회 -> post_id 목록 확보
    - posts를 `in(id, post_ids)`로 일괄 조회
    - profiles를 `in(id, user_ids)`로 일괄 조회
  - 항목 표시
    - rank number
    - badge pill
    - score
    - thumbnail
    - 작성자 nickname/avatar
  - 항목 클릭 시 `/p/[id]` 이동

### 3) 랭킹 유틸 추가
- `lib/rankings.ts`
  - period 파싱/뷰 이름 변환
  - badge 라벨/스타일 유틸
  - post_id 목록 기반 뱃지 일괄 조회 유틸

### 4) (선택) /feed + /p/[id] 카드 뱃지 반영
- `app/feed/page.tsx`
  - 현재 페이지의 post_id들만 대상으로 주간 뱃지 조회(in)
  - 카드에 badge 전달
- `app/p/[id]/page.tsx`
  - 상세 단건도 주간 뱃지 조회 후 표시
- `components/post/PostItemCard.tsx`
  - badge pill 렌더링 추가

### 5) 품질 검증
- `npm run lint` 통과
- `npm run build` 통과

### 6) 사용자(운영) 확인 항목
- Supabase에서 `weekly_post_rankings`, `monthly_post_rankings` 뷰 생성 완료 필요
- `/rank` 탭 전환 시 데이터가 실제 votes 기반으로 바뀌는지 확인
- 배포 환경에서 RLS/권한 문제 없이 랭킹 조회 가능한지 확인

## 2026-02-16 Part 9 /me 마이페이지 고도화 구현 기록

### 1) /me 탭 UI 및 데이터 로딩 구현
- `app/me/page.tsx`
  - 탭 UI 구성: `내 글` / `내 좋아요` / `내 댓글`
  - 로그인 사용자 기준으로 탭별 데이터 조회
  - 비로그인 상태는 안내 메시지 표시
  - 탭별 오류 상태 UI 분기
- `app/me/loading.tsx`
  - 서버 데이터 로딩 중 스켈레톤 UI 제공

### 2) 내 글 데이터 로딩
- 조회 조건
  - `posts.user_id = auth.uid()`
  - `posts.deleted_at is null`
  - 최신순 + 20개 단위(+1 조회로 더보기 여부 판단)
- N+1 방지
  - 현재 페이지 post ids 기준 votes를 `in()`으로 1회 조회해 count/likedByMe 매핑
  - 주간 badge도 `in()`으로 1회 조회
- 컴포넌트
  - `components/me/MyPosts.tsx`

### 3) 내 좋아요 데이터 로딩
- 조회 조건
  - `votes.voter_id = auth.uid()`
  - 최신순 50개
- N+1 방지
  - votes에서 post_id 목록 확보 후 `posts.in(id, post_ids)` 1회 조회
  - votes 순서를 기준으로 최종 리스트 매핑
- 컴포넌트
  - `components/me/MyLikes.tsx`

### 4) 내 댓글 데이터 로딩
- 조회 조건
  - `comments.user_id = auth.uid()`
  - `comments.deleted_at is null`
  - 최신순 50개
- N+1 방지
  - comments의 post_id 목록으로 `posts.in(id, post_ids)` 1회 조회
  - 댓글 카드에 post thumbnail/caption 결합
- 컴포넌트
  - `components/me/MyComments.tsx`

### 5) 프로필 편집 + 탈퇴(soft delete)
- `components/me/ProfileEditor.tsx`
  - nickname, avatar_url 수정
  - 저장 성공/실패 안내 메시지
  - 저장 후 `router.refresh()` + 헤더 갱신 이벤트 전송
- `components/me/AccountDangerZone.tsx`
  - 탈퇴 확인(confirm)
  - `profiles.deleted_at = now()` 업데이트
  - `supabase.auth.signOut()` 후 `/` 이동
- `components/Header.tsx`
  - `danga:refresh-header-user` 이벤트 수신 시 헤더 프로필 상태 재동기화

### 6) Supabase 작업 (MCP 사용)
- 로컬 migration 추가
  - `supabase/migrations/20260216_profiles_soft_delete.sql`
  - `profiles.deleted_at` 컬럼/인덱스 보강
- 문서 SQL 반영
  - `docs/sql/profiles.sql`에 `deleted_at` + 인덱스 추가
- MCP 실제 반영
  - `part9_profiles_soft_delete` migration을 Supabase에 적용(`success: true`)

### 7) 문서 반영
- `README.md`
  - Part 9 기능(마이페이지 탭/프로필 편집/탈퇴) 설명 추가
  - 폴더 구조에 `components/me/*`, `app/me/loading.tsx`, 신규 migration 반영
